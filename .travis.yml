language: java

addons:
    apt:
        packages:
            - oracle-java8-installer

git:
    depth: 1

branches:
    only:
        - Dec2016Lite-Java

before_cache:
    # Clean caches
    - rm -f  $HOME/monetdb-java-lite/.gradle/caches/modules-2/modules-2.lock
    - rm -rf $HOME/monetdb-java-lite/.gradle/caches/*/plugin-resolution/

cache:
    directories:
        - $HOME/monetdb-java-lite/.gradle/caches/
        - $HOME/monetdb-java-lite/.gradle/wrapper/

env:
    global:
        # From http://stackoverflow.com/a/21841688
        - TERM=dumb
        # Deployment target for oxcross
        - MACOSX_DEPLOYMENT_TARGET=10.9

before_install:
    # From http://stackoverflow.com/a/11069162
    - sudo apt-get -qy update
    - sudo apt-get -qy install aptitude autoconf automake libtool gettext
    # To compile to 64-bit Windows binaries (override some headers)
    - sudo aptitude install -y gcc-mingw-w64
    - sudo cp src/embedded/windows/mingwheaders/intrin.h /usr/x86_64-w64-ming32/include
    - sudo cp src/embedded/windows/mingwheaders/stdlib.h /usr/x86_64-w64-ming32/include
    - sudo cp src/embedded/windows/mingwheaders/time.h /usr/x86_64-w64-ming32/include
    - sudo cp src/embedded/windows/mingwheaders/intrin-impl.h /usr/x86_64-w64-ming32/include/psdk_inc
    # To compile for OS X, we need osxcross
    - sudo apt-get -qy install gcc zlib1g-dev libmpc-dev libmpfr-dev libgmp-dev
    - cd ..
    - git clone --depth=1 https://github.com/tpoechtrager/osxcross
    - cd osxcross
    - (cd tarballs; wget https://dl.dropboxusercontent.com/u/1463845/osxcross/MacOSX10.9.sdk.tar.bz2)
    - sudo tools/get_dependencies.sh
    - yes | ./build_gcc.sh
    - eval `target/bin/osxcross-env`

install:
    # Disable default "./gradlew assemble" command.
    # See http://stackoverflow.com/a/23416671
    - true

script:
    - jdk_switcher use oraclejdk8
    # Compile for the 3 operative systems! May the God be with us!
    - bash compile.sh linux
    - bash compile.sh macos
    - bash compile.sh windows
    # Assemble everything with Gradle
    - cd monetdb-java-lite
    - ./gradlew -i build

after_success:
    # Publish to our repository
    - cd monetdb-java-lite
    #- ./gradlew -i artifactoryPublish

